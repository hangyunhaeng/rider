<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="stsDAO">
	<select id="selectBalanceConfirmList" parameterType="egovframework.com.rd.usr.service.vo.BalanceVO" resultType="egovframework.com.rd.usr.service.vo.BalanceVO">
		<if test="schIdx !=0 and schPagePerCnt != 0">
		SELECT * FROM (
			SELECT ROWNUM() RN,m.*
			FROM (
		</if>
				SELECT a.COOPERATOR_ID, a.ESNTL_ID, a.DAY
				<![CDATA[
					, if(a.BALANCE1 <0 , BALANCE0+BALANCE1, BALANCE0) AS BALANCE0 , if(a.BALANCE1 <0 , 0, BALANCE1) AS BALANCE1
					, if(a.ABLE_BALANCE1 <0 , ABLE_BALANCE0+ABLE_BALANCE1, ABLE_BALANCE0) AS ABLE_BALANCE0 , if(a.ABLE_BALANCE1 <0 , 0, ABLE_BALANCE1) AS ABLE_BALANCE1
				]]>
					, if(a.COOPERATOR_ID = #{cooperatorMberId}, d.USER_NM,b.MBER_NM) AS MBER_NM, c.COOPERATOR_NM
					, if(a.COOPERATOR_ID = #{cooperatorMberId}, d.EMPLYR_ID,b.mber_id) AS mber_id
					, if(a.ESNTL_ID = #{cooperatorMberId}, '협력사', if(a.COOPERATOR_ID = #{cooperatorMberId}, '영업사원','라이더')) AS GUBUN_NM

				FROM RD_BALANCE_CONFIRM a
				LEFT JOIN COMTNGNRLMBER b ON a.ESNTL_ID = b.ESNTL_ID
				LEFT JOIN RD_COOPERATOR c ON a.COOPERATOR_ID = c.COOPERATOR_ID
				LEFT JOIN COMTNEMPLYRINFO d ON a.ESNTL_ID = d.ESNTL_ID
				WHERE DAY BETWEEN #{searchFromDate} AND #{searchToDate}
				<if test='searchCooperatorId != "all" and searchGubun == "R"'>
					AND a.ESNTL_ID != #{cooperatorMberId} AND a.COOPERATOR_ID != #{cooperatorMberId}
				</if>
				<if test='searchCooperatorId != "all" and searchGubun == "S"'>
					AND a.COOPERATOR_ID = #{cooperatorMberId}
				</if>
				<if test='searchCooperatorId != "all" and searchGubun == "C"'>
					AND a.ESNTL_ID = #{cooperatorMberId}
				</if>

		<if test="schIdx !=0 and schPagePerCnt != 0">
			) m
		) m
		<![CDATA[WHERE RN > #{schIdx}*#{schPagePerCnt} -#{schPagePerCnt} AND RN <= #{schIdx}*#{schPagePerCnt}]]>
		</if>
	</select>


	<select id="selectBalanceConfirmListCnt" parameterType="egovframework.com.rd.usr.service.vo.BalanceVO" resultType="egovframework.com.rd.usr.service.vo.BalanceVO">
		SELECT COUNT(COOPERATOR_ID) AS TOTAL_CNT
		FROM RD_BALANCE_CONFIRM
		WHERE DAY BETWEEN #{searchFromDate} AND #{searchToDate}
			<if test='searchCooperatorId != "all" and searchGubun == "R"'>
			AND ESNTL_ID != #{cooperatorMberId}
			</if>
			<if test='searchCooperatorId != "all" and searchGubun == "C"'>
			AND ESNTL_ID = #{cooperatorMberId}
			</if>
	</select>

	<select id="selectSts0002" parameterType="egovframework.com.rd.usr.service.vo.StsVO" resultType="egovframework.com.rd.usr.service.vo.StsVO">
		SELECT
			tab.COOPERATOR_ID, a.COOPERATOR_NM, tab.DAY, SUM(tab.DELIVERY_CNT) DELIVERY_CNT, SUM(tab.DELIVERY_PRICE) AS DELIVERY_PRICE
			, SUM(tab.COST_C_OPER) AS COST_C_OPER, SUM(tab.COST_C_COOP) AS COST_C_COOP, SUM(tab.COST_P_OPER) AS COST_P_OPER, SUM(tab.COST_P_SALE) AS COST_P_SALE
		FROM
		(
			SELECT a.COOPERATOR_ID, a.DAY
			-- 배달건수 : 주정산때의 보정된 건수는 어떻게 할까?
			, SUM(a.DELIVERY_CNT) AS DELIVERY_CNT
			, SUM(a.DELIVERY_PRICE) AS DELIVERY_PRICE
			-- 콜수수료 : 운영사, 협력사
			, nvl(SUM( if(c.GUBUN = 'C', c.COST, 0)), 0) AS COST_C_OPER
			, nvl(SUM( if(d.GUBUN = 'C', d.COST, 0)), 0) AS COST_C_COOP
			-- 운영비 : 운영사, 영업사원
			, nvl(SUM( if(c.GUBUN = 'P', c.COST, 0)), 0) AS COST_P_OPER
			, nvl(SUM( if(c.GUBUN = 'P', e.COST, 0)), 0) AS COST_P_SALE
			FROM RD_DAY_PAY a
			LEFT JOIN RD_PROFIT c ON a.DYP_ID = c.DYP_ID AND c.USE_AT ='Y' -- 운영사
			LEFT JOIN RD_COOPERATOR_PROFIT d ON a.DYP_ID = d.DYP_ID AND d.USE_AT ='Y' -- 협력사
			LEFT JOIN RD_SALES_PROFIT e ON a.DYP_ID = e.DYP_ID AND e.USE_AT ='Y' -- 영업사원
			WHERE DAY BETWEEN #{searchFromDate} AND #{searchToDate}
			AND a.IO_GUBUN ='1'
			AND a.USE_AT ='Y'
			GROUP BY a.COOPERATOR_ID, a.DAY

			UNION all

			SELECT
			COOPERATOR_ID, DELIVERY_DAY AS DAY, MAX(DELIVERY_CNT) AS DELIVERY_CNT, SUM(DELIVERY_PRICE) AS DELIVERY_PRICE
			, SUM(COST_C_OPER) AS COST_C_OPER, SUM(COST_C_COOP) AS COST_C_COOP, SUM(COST_P_OPER) AS COST_P_OPER, SUM(COST_P_SALE) AS COST_P_SALE
			FROM (
				SELECT a.COOPERATOR_ID, a.DELIVERY_DAY, a.DELIVERY_CNT, a.DELIVERY_COST AS DELIVERY_PRICE
				-- 콜수수료 : 운영사, 협력사
				, nvl(SUM(if(a.GUBUN = 'C', a.COST, 0)), 0) AS COST_C_OPER
				, 0 AS COST_C_COOP
				-- 운영비 : 운영사, 영업사원
				, nvl(SUM(if(a.GUBUN = 'P', a.COST, 0)), 0) AS COST_P_OPER
				, 0 AS COST_P_SALE
				, 'O' AS gubun
				FROM RD_PROFIT a
				WHERE a.DYP_ID IS NULL
				AND a.DELIVERY_DAY BETWEEN #{searchFromDate} AND #{searchToDate}
				AND a.GUBUN IN ('C', 'P')
				AND a.USE_AT ='Y'
				GROUP BY a.COOPERATOR_ID, a.DELIVERY_DAY, a.GUBUN

				UNION ALL

				SELECT a.COOPERATOR_ID, a.DELIVERY_DAY, a.DELIVERY_CNT, a.DELIVERY_COST AS DELIVERY_PRICE
				-- 콜수수료 : 운영사, 협력사
				, 0 AS COST_C_OPER
				, nvl(SUM(if(a.GUBUN = 'C', a.COST, 0)), 0) AS COST_C_COOP
				-- 운영비 : 운영사, 영업사원
				, 0 AS COST_P_OPER
				, 0 AS COST_P_SALE
				, 'C' AS GUBUN
				FROM RD_COOPERATOR_PROFIT a
				WHERE a.DYP_ID IS NULL
				AND a.DELIVERY_DAY BETWEEN #{searchFromDate} AND #{searchToDate}
				AND a.GUBUN IN ('C', 'P')
				AND a.USE_AT ='Y'
				GROUP BY a.COOPERATOR_ID, a.DELIVERY_DAY, a.GUBUN

				UNION ALL

				SELECT a.COOPERATOR_ID, a.DELIVERY_DAY, a.DELIVERY_CNT, 0 AS DELIVERY_PRICE
				-- 콜수수료 : 운영사, 협력사
				, 0 AS COST_C_OPER
				, 0 AS COST_C_COOP
				-- 운영비 : 운영사, 영업사원
				, 0 AS COST_P_OPER
				, nvl(SUM(if(a.GUBUN = 'P', a.COST, 0)), 0) AS COST_P_SALE
				, 'S' AS GUBUN
				FROM RD_SALES_PROFIT a
				WHERE a.DYP_ID IS NULL
				AND a.DELIVERY_DAY BETWEEN #{searchFromDate} AND #{searchToDate}
				AND a.GUBUN IN ('C', 'P')
				AND a.USE_AT ='Y'
				GROUP BY a.COOPERATOR_ID, a.DELIVERY_DAY, a.GUBUN
			) tab
			GROUP BY tab.COOPERATOR_ID, tab.DELIVERY_DAY
		) tab
		LEFT JOIN RD_COOPERATOR a ON tab.COOPERATOR_ID = a.COOPERATOR_ID
		WHERE 1 = 1
			<if test="schAuthorCode == 'ROLE_USER'">
			/* 협력사 조건 */
			AND a.REGISTRATION_SN = #{schIhidNum} AND a.use_at ='Y'
			</if>
			<if test='searchCooperatorId != null and searchCooperatorId != "all"'>
			AND a.cooperator_id = #{searchCooperatorId}
			</if>
		GROUP BY tab.COOPERATOR_ID, tab.DAY
	</select>

	<select id="selectSts0003" parameterType="egovframework.com.rd.usr.service.vo.StsVO" resultType="egovframework.com.rd.usr.service.vo.StsVO">
		SELECT
			tab.COOPERATOR_ID, a.COOPERATOR_NM, tab.DAY, tab.MBER_ID, b.MBER_NM, SUM(tab.DELIVERY_CNT) DELIVERY_CNT, SUM(tab.DELIVERY_PRICE) AS DELIVERY_PRICE
			, SUM(tab.COST_C_OPER) AS COST_C_OPER, SUM(tab.COST_C_COOP) AS COST_C_COOP, SUM(tab.COST_P_OPER) AS COST_P_OPER, SUM(tab.COST_P_SALE) AS COST_P_SALE
		FROM
		(
			SELECT a.COOPERATOR_ID, a.DAY, a.MBER_ID
			-- 배달건수 : 주정산때의 보정된 건수는 어떻게 할까?
			, SUM(a.DELIVERY_CNT) AS DELIVERY_CNT
			, SUM(a.DELIVERY_PRICE) AS DELIVERY_PRICE
			-- 콜수수료 : 운영사, 협력사
			, nvl(SUM( if(c.GUBUN = 'C', c.COST, 0)), 0) AS COST_C_OPER
			, nvl(SUM( if(d.GUBUN = 'C', d.COST, 0)), 0) AS COST_C_COOP
			-- 운영비 : 운영사, 영업사원
			, nvl(SUM( if(c.GUBUN = 'P', c.COST, 0)), 0) AS COST_P_OPER
			, nvl(SUM( if(c.GUBUN = 'P', e.COST, 0)), 0) AS COST_P_SALE
			FROM RD_DAY_PAY a
			LEFT JOIN RD_PROFIT c ON a.DYP_ID = c.DYP_ID AND c.USE_AT ='Y' -- 운영사
			LEFT JOIN RD_COOPERATOR_PROFIT d ON a.DYP_ID = d.DYP_ID AND d.USE_AT ='Y' -- 협력사
			LEFT JOIN RD_SALES_PROFIT e ON a.DYP_ID = e.DYP_ID AND e.USE_AT ='Y' -- 영업사원
			WHERE DAY BETWEEN #{searchFromDate} AND #{searchToDate}
			AND a.IO_GUBUN ='1'
			AND a.USE_AT ='Y'
			GROUP BY a.COOPERATOR_ID, a.DAY, a.MBER_ID

			UNION all

			SELECT
			COOPERATOR_ID, DELIVERY_DAY AS DAY, MBER_ID, MAX(DELIVERY_CNT) AS DELIVERY_CNT, SUM(DELIVERY_PRICE) AS DELIVERY_PRICE
			, SUM(COST_C_OPER) AS COST_C_OPER, SUM(COST_C_COOP) AS COST_C_COOP, SUM(COST_P_OPER) AS COST_P_OPER, SUM(COST_P_SALE) AS COST_P_SALE
			FROM (
				SELECT a.COOPERATOR_ID, a.DELIVERY_DAY, a.MBER_ID, a.DELIVERY_CNT, a.DELIVERY_COST AS DELIVERY_PRICE
				-- 콜수수료 : 운영사, 협력사
				, nvl(SUM(if(a.GUBUN = 'C', a.COST, 0)), 0) AS COST_C_OPER
				, 0 AS COST_C_COOP
				-- 운영비 : 운영사, 영업사원
				, nvl(SUM(if(a.GUBUN = 'P', a.COST, 0)), 0) AS COST_P_OPER
				, 0 AS COST_P_SALE
				, 'O' AS gubun
				FROM RD_PROFIT a
				WHERE a.DYP_ID IS NULL
				AND a.DELIVERY_DAY BETWEEN #{searchFromDate} AND #{searchToDate}
				AND a.GUBUN IN ('C', 'P')
				AND a.USE_AT ='Y'
				GROUP BY a.COOPERATOR_ID, a.DELIVERY_DAY, a.GUBUN, a.MBER_ID

				UNION ALL

				SELECT a.COOPERATOR_ID, a.DELIVERY_DAY, a.MBER_ID, a.DELIVERY_CNT, a.DELIVERY_COST AS DELIVERY_PRICE
				-- 콜수수료 : 운영사, 협력사
				, 0 AS COST_C_OPER
				, nvl(SUM(if(a.GUBUN = 'C', a.COST, 0)), 0) AS COST_C_COOP
				-- 운영비 : 운영사, 영업사원
				, 0 AS COST_P_OPER
				, 0 AS COST_P_SALE
				, 'C' AS GUBUN
				FROM RD_COOPERATOR_PROFIT a
				WHERE a.DYP_ID IS NULL
				AND a.DELIVERY_DAY BETWEEN #{searchFromDate} AND #{searchToDate}
				AND a.GUBUN IN ('C', 'P')
				AND a.USE_AT ='Y'
				GROUP BY a.COOPERATOR_ID, a.DELIVERY_DAY, a.GUBUN, a.MBER_ID

				UNION ALL

				SELECT a.COOPERATOR_ID, a.DELIVERY_DAY, a.MBER_ID, a.DELIVERY_CNT, 0 AS DELIVERY_PRICE
				-- 콜수수료 : 운영사, 협력사
				, 0 AS COST_C_OPER
				, 0 AS COST_C_COOP
				-- 운영비 : 운영사, 영업사원
				, 0 AS COST_P_OPER
				, nvl(SUM(if(a.GUBUN = 'P', a.COST, 0)), 0) AS COST_P_SALE
				, 'S' AS GUBUN
				FROM RD_SALES_PROFIT a
				WHERE a.DYP_ID IS NULL
				AND a.DELIVERY_DAY BETWEEN #{searchFromDate} AND #{searchToDate}
				AND a.GUBUN IN ('C', 'P')
				AND a.USE_AT ='Y'
				GROUP BY a.COOPERATOR_ID, a.DELIVERY_DAY, a.GUBUN, a.MBER_ID
			) tab
			GROUP BY tab.COOPERATOR_ID, tab.DELIVERY_DAY, tab.MBER_ID
		) tab
		LEFT JOIN RD_COOPERATOR a ON tab.COOPERATOR_ID = a.COOPERATOR_ID
		LEFT JOIN COMTNGNRLMBER b ON tab.MBER_ID = b.MBER_ID
		WHERE 1 = 1
			<if test="schAuthorCode == 'ROLE_USER'">
			/* 협력사 조건 */
			AND a.REGISTRATION_SN = #{schIhidNum} AND a.use_at ='Y'
			</if>
			<if test='searchCooperatorId != null and searchCooperatorId != "all"'>
			AND a.COOPERATOR_ID = #{searchCooperatorId}
			</if>
			<if test='searchNm != null and searchNm != ""'>
			 AND tab.MBER_ID LIKE '%' #{searchNm} '%' OR b.MBER_NM LIKE '%' #{searchNm} '%'
			</if>
		GROUP BY tab.COOPERATOR_ID, tab.DAY, tab.mber_id
	</select>

	<select id="selectCooperatorProfitStsList" parameterType="egovframework.com.rd.usr.service.vo.StsVO" resultType="egovframework.com.rd.usr.service.vo.StsVO">
		-- 콜수수료, 기타수수료, 선지급수수료(부가세, 원천세, 관리비, 사업주부담고용보험료, 사업주부담산재보험료 제외)
		SELECT NVL(SUM(b.COST), 0) AS COST, fix.ACCOUNTS_ED_DT AS DAY, c.COOPERATOR_NM, fix.COOPERATOR_ID
		FROM (
			SELECT sub_tab.ACCOUNTS_ED_DT , b.COOPERATOR_ID
			FROM (SELECT ACCOUNTS_ED_DT FROM RD_WEEK_INFO
			WHERE FIX_DAY IS NOT NULL
			GROUP BY ACCOUNTS_ED_DT desc
			LIMIT 7) sub_tab -- 최근 7주만 조회
			LEFT JOIN RD_COOPERATOR b ON b.USE_AT ='Y'
		) AS fix
		LEFT JOIN RD_WEEK_INFO a ON fix.COOPERATOR_ID = a.COOPERATOR_ID AND fix.ACCOUNTS_ED_DT = a.ACCOUNTS_ED_DT  AND a.FIX_DAY IS NOT NULL
		LEFT JOIN RD_COOPERATOR_PROFIT b ON a.WEEK_ID = b.WEEK_ID AND b.USE_AT ='Y' AND b.GUBUN IN ('C','E','D')
		LEFT JOIN RD_COOPERATOR c ON fix.COOPERATOR_ID = c.COOPERATOR_ID
		where 1 = 1
			<if test="schAuthorCode == 'ROLE_USER'">
			/* 협력사 조건 */
			AND c.REGISTRATION_SN = #{schIhidNum} AND c.use_at ='Y'
			</if>

		GROUP BY fix.ACCOUNTS_ED_DT, fix.COOPERATOR_ID
		ORDER BY fix.ACCOUNTS_ED_DT
	</select>

	<select id="selectCooperatorDeliveryCntStsList" parameterType="egovframework.com.rd.usr.service.vo.StsVO" resultType="egovframework.com.rd.usr.service.vo.StsVO">
		-- 배달건수
		SELECT NVL(SUM(b.cnt), 0) AS cnt, fix.ACCOUNTS_ED_DT AS DAY, c.COOPERATOR_NM, fix.COOPERATOR_ID
		FROM (
			SELECT sub_tab.ACCOUNTS_ED_DT , b.COOPERATOR_ID
			FROM (SELECT ACCOUNTS_ED_DT FROM RD_WEEK_INFO
			WHERE FIX_DAY IS NOT NULL
			GROUP BY ACCOUNTS_ED_DT desc
			LIMIT 7) sub_tab -- 최근 7주만 조회
			LEFT JOIN RD_COOPERATOR b ON b.USE_AT ='Y'
		) AS fix
		LEFT JOIN RD_WEEK_INFO a ON fix.COOPERATOR_ID = a.COOPERATOR_ID AND fix.ACCOUNTS_ED_DT = a.ACCOUNTS_ED_DT  AND a.FIX_DAY IS NOT NULL
		LEFT JOIN RD_WEEK_RIDER_INFO b ON a.WEEK_ID = b.WEEK_ID
		LEFT JOIN RD_COOPERATOR c ON fix.COOPERATOR_ID = c.COOPERATOR_ID
		where 1 = 1
			<if test="schAuthorCode == 'ROLE_USER'">
			/* 협력사 조건 */
			AND c.REGISTRATION_SN = #{schIhidNum} AND c.use_at ='Y'
			</if>

		GROUP BY fix.ACCOUNTS_ED_DT, fix.COOPERATOR_ID
		ORDER BY fix.ACCOUNTS_ED_DT
	</select>
</mapper>