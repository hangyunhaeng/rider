<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="payDAO">

	<resultMap id="doszResultVO" type="egovframework.com.rd.usr.service.vo.DoszResultVO">
		<result property="org_telegram_no" column="TELEGRAM_NO"/>
		<result property="tr_dt" column="TRAN_DAY"/>
	</resultMap>

	<select id="selectPayList" parameterType="egovframework.com.rd.usr.service.vo.HistoryVO" resultType="egovframework.com.rd.usr.service.vo.HistoryVO">
		SELECT * FROM(
			SELECT a.cooperator_id,'DAY' AS dw_gubun,'선지급' AS gubun, DYP_ID AS ID, if(a.io_gubun=1, a.ABLE_PRICE, a.send_price) as send_price, a.day_fee+a.insurance+a.send_fee AS fee
			, b.tran_day, b.TELEGRAM_NO, b.rv_account, b.status, b.status_cd
			, case when a.etc_id is not null then '' when b.status='200' then '성공' when b.STATUS= '999' then '처리중' when io_gubun=2 AND b.STATUS= '400' AND b.error_code='VTIM' then '처리중' when io_gubun=2 AND b.STATUS= '400' AND b.error_code='0011' then '처리중'  when io_gubun=2 then '실패' ELSE '' end AS status_nm
			, b.send_dt, b.send_tm, b.ERROR_MESSAGE
			, case when io_gubun='1' then DATE_FORMAT(a.CREAT_DT, '%Y%m%d%H%i%s')
					when io_gubun = '2' AND a.etc_id IS NOT NULL then DATE_FORMAT(a.CREAT_DT, '%Y%m%d%H%i%s')
					when io_gubun = '2' then if(b.STATUS_CD = '0000', concat(b.send_dt,b.send_tm), DATE_FORMAT(b.creat_dt, '%Y%m%d%H%i%s')) ELSE '' END  AS CREAT_DT
			, c.MBER_NM, d.COOPERATOR_NM, io_gubun
			, case when io_gubun = '1' then '입금'
						when io_gubun ='2' AND a.etc_id IS NULL then '출금'
						when io_gubun ='2' AND a.etc_id IS NOT NULL AND g.gubun ='D' then '대여'
						when io_gubun ='2' AND a.etc_id IS NOT NULL AND g.gubun ='R' then '리스'
						when io_gubun ='2' AND a.etc_id IS NOT NULL AND g.gubun ='E' then '기타'
						ELSE  ''
						end AS io_gubun_nm
			, DAY_ATCH_FILE_ID, WEK_ATCH_FILE_ID
			, week_yn, case when week_yn = 'Y' then '정산완료' ELSE '선지급' END week_NM
			, a.DAY AS ACCOUNTS_ST_DT, '' AS ACCOUNTS_ED_DT, e.CD_NM AS RV_BANK_NM, a.mber_id, DATE_FORMAT(f.CREAT_DT, '%Y%m%d') AS FILE_DATE
			FROM RD_DAY_PAY a
			LEFT JOIN RD_TRANSFER b ON a.tran_day = b.tran_day AND a.TELEGRAM_NO = b.TELEGRAM_NO
			LEFT JOIN COMTNGNRLMBER c ON a.mber_id = c.mber_id
			LEFT JOIN RD_COOPERATOR d ON a.COOPERATOR_ID= d.COOPERATOR_ID
			LEFT JOIN RD_CD e ON b.RV_BANK_CODE = e.CD AND e.CD_GROUP ='BANK_CD'
			LEFT JOIN COMTNFILE f ON a.DAY_ATCH_FILE_ID = f.ATCH_FILE_ID
			LEFT JOIN RD_ETC g ON a.etc_id = g.ETC_ID AND g.USE_AT ='Y'
			WHERE 1=1
			/* AND a.use_at ='Y' 관리자는 실패도 조회 */
			AND a.week_yn ='N'	/*정산완료된 출금이력은 주정산으로 넘어가기때문에 제외한다*/
			AND a.io_gubun = '2'
			AND a.etc_id is null	/* 대여도 제외 */
			<if test='searchCooperatorId != null and searchCooperatorId != "all"'>
			AND a.cooperator_id = #{searchCooperatorId}
			</if>
			<if test="searchNm != null and searchNm != ''">
			AND c.mber_nm like '%' #{searchNm} '%'
			</if>
			AND DATE_FORMAT(a.CREAT_DT,'%Y%m%d') BETWEEN #{searchFromDate} AND #{searchToDate}
			<if test="searchRegistrationSn != null and searchRegistrationSn != ''">
			AND a.COOPERATOR_ID IN (
				SELECT COOPERATOR_ID from RD_COOPERATOR
				WHERE REGISTRATION_SN = #{searchRegistrationSn}
			)
			</if>
			UNION all

			SELECT a.cooperator_id, dw_gubun, if(dw_gubun='DAY', '선지급', '정산') AS gubun, wkp_id AS ID, if(a.io_gubun=1, a.ABLE_PRICE, a.send_price) as send_price, a.fee
			, b.tran_day, b.TELEGRAM_NO, b.rv_account, b.status, b.status_cd
			, case when a.etc_id is not null then '' when b.status='200' then '성공' when b.STATUS= '999' then '처리중' when io_gubun=2 AND b.STATUS= '400' AND b.error_code='VTIM' then '처리중' when io_gubun=2 AND b.STATUS= '400' AND b.error_code='0011' then '처리중'  when io_gubun=2 then '실패' ELSE '' end AS status_nm
			, b.send_dt, b.send_tm, b.ERROR_MESSAGE
			, case when io_gubun='1' then DATE_FORMAT(a.CREAT_DT, '%Y%m%d%H%i%s')
					when io_gubun = '2' AND a.etc_id IS NOT NULL then DATE_FORMAT(a.CREAT_DT, '%Y%m%d%H%i%s')
					when io_gubun = '2' then if(b.STATUS_CD = '0000', concat(b.send_dt,b.send_tm), DATE_FORMAT(b.creat_dt, '%Y%m%d%H%i%s')) ELSE '' END  AS CREAT_DT
			, c.MBER_NM, d.COOPERATOR_NM, io_gubun
			, case when io_gubun = '1' then '입금'
						when io_gubun ='2' AND a.etc_id IS NULL then '출금'
						when io_gubun ='2' AND a.etc_id IS NOT NULL AND g.gubun ='D' then '대여'
						when io_gubun ='2' AND a.etc_id IS NOT NULL AND g.gubun ='R' then '리스'
						when io_gubun ='2' AND a.etc_id IS NOT NULL AND g.gubun ='E' then '기타'
						ELSE  ''
						end AS io_gubun_nm
			, '' as DAY_ATCH_FILE_ID, a.atch_file_id AS WEK_ATCH_FILE_ID
			, '' week_yn, '정산완료' AS week_NM
			, ACCOUNTS_ST_DT, ACCOUNTS_ED_DT, e.CD_NM AS RV_BANK_NM, a.mber_id, DATE_FORMAT(f.CREAT_DT, '%Y%m%d') AS FILE_DATE
			FROM RD_WEEK_PAY a
			LEFT JOIN RD_TRANSFER b ON a.tran_day = b.tran_day AND a.TELEGRAM_NO = b.TELEGRAM_NO
			LEFT JOIN COMTNGNRLMBER c ON a.mber_id = c.mber_id
			LEFT JOIN RD_COOPERATOR d ON a.COOPERATOR_ID= d.COOPERATOR_ID
			LEFT JOIN RD_CD e ON b.RV_BANK_CODE = e.CD AND e.CD_GROUP ='BANK_CD'
			LEFT JOIN COMTNFILE f ON a.ATCH_FILE_ID = f.ATCH_FILE_ID
			LEFT JOIN RD_ETC g ON a.etc_id = g.ETC_ID AND g.USE_AT ='Y'
			WHERE 1=1
			/* AND a.use_at ='Y' 관리자는 실패도 조회 */
			AND a.io_gubun = '2'
			AND a.etc_id is null	/* 대여도 제외 */
			<if test='searchCooperatorId != null and searchCooperatorId != "all"'>
			AND a.cooperator_id = #{searchCooperatorId}
			</if>
			<if test="searchNm != null and searchNm != ''">
			AND c.mber_nm like '%' #{searchNm} '%'
			</if>
			AND DATE_FORMAT(a.CREAT_DT,'%Y%m%d') BETWEEN #{searchFromDate} AND #{searchToDate}
			<if test="searchRegistrationSn != null and searchRegistrationSn != ''">
			AND a.COOPERATOR_ID IN (
				SELECT COOPERATOR_ID from RD_COOPERATOR
				WHERE REGISTRATION_SN = #{searchRegistrationSn}
			)
			</if>

		) tab
		WHERE 1=1
			<if test="searchDwGubun != null and searchDwGubun != ''">
			AND dw_gubun = #{searchDwGubun}
			</if>
			<if test="schAuthorCode == 'ROLE_USER'">
			/* 협력사 조건 */
			AND COOPERATOR_ID IN (
				SELECT COOPERATOR_ID FROM RD_COOPERATOR a
				WHERE a.REGISTRATION_SN = #{schIhidNum} AND use_at ='Y'
			)
			</if>
		ORDER BY creat_dt desc
	</select>
	<select id="selectTransterProsseceResult" resultMap="doszResultVO">
		SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
		WHERE STATUS = '999'

		UNION ALL

		SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
		WHERE STATUS = '400'
		AND error_code IN ('VTIM', '0011')
	</select>
	<select id="selectForUpdateBalanceTranster" parameterType="egovframework.com.rd.usr.service.vo.Sch" resultType="egovframework.com.rd.usr.service.vo.BalanceVO">
		SELECT * FROM RD_BALANCE
		WHERE (COOPERATOR_ID, ESNTL_ID) IN (
					/*일정산*/
					SELECT a.COOPERATOR_ID, b.ESNTL_ID FROM RD_DAY_PAY a JOIN COMTNGNRLMBER b ON a.mber_id = b.MBER_ID
					WHERE (TELEGRAM_NO, TRAN_DAY) IN (

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '999'

							UNION ALL

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '400'
							AND error_code IN ('VTIM', '0011')
					)
					AND use_at ='Y'

					UNION

					/*주정산*/
					SELECT a.COOPERATOR_ID, b.ESNTL_ID FROM RD_WEEK_PAY a JOIN COMTNGNRLMBER b ON a.MBER_ID = b.MBER_ID
					WHERE (TELEGRAM_NO, TRAN_DAY) IN (

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '999'

							UNION ALL

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '400'
							AND error_code IN ('VTIM', '0011')
					)
					AND use_at ='Y'

					UNION

					/*협력사 선입금 수수료 */
					SELECT COOPERATOR_ID, #{cooperatorMberId} AS ESNTL_ID FROM RD_DAY_PAY
					WHERE (TELEGRAM_NO, TRAN_DAY) IN (

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '999'

							UNION ALL

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '400'
							AND error_code IN ('VTIM', '0011')
					)
					GROUP BY COOPERATOR_ID


					UNION

					/*협력사 출금 */
					SELECT COOPERATOR_ID, #{cooperatorMberId} AS ESNTL_ID FROM RD_COOPERATOR_PAY
					WHERE (TELEGRAM_NO, TRAN_DAY) IN (

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '999'

							UNION ALL

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '400'
							AND error_code IN ('VTIM', '0011')
					)
					GROUP BY COOPERATOR_ID

					UNION

					/*영업사원 출금*/
					SELECT #{cooperatorMberId} AS COOPERATOR_ID,  b.ESNTL_ID FROM RD_SALES_PAY a JOIN COMTNEMPLYRINFO b ON a.EMPLYR_ID = b.EMPLYR_ID
					WHERE (TELEGRAM_NO, TRAN_DAY) IN (

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '999'

							UNION ALL

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '400'
							AND error_code IN ('VTIM', '0011')
					)


					UNION


					/*영업사원 선입금 수수료 */
					SELECT #{cooperatorMberId} AS COOPERATOR_ID, c.ESNTL_ID FROM RD_DAY_PAY a
					JOIN RD_SALES_PROFIT b ON a.DYP_ID = b.DYP_ID
					JOIN COMTNEMPLYRINFO c ON b.EMPLYR_ID = c.EMPLYR_ID
					WHERE (a.TELEGRAM_NO, a.TRAN_DAY) IN (

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '999'

							UNION ALL

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '400'
							AND error_code IN ('VTIM', '0011')
					)
					GROUP BY a.COOPERATOR_ID, c.ESNTL_ID


					UNION


					/*영업사원 선입금 수수료 */
					SELECT #{cooperatorMberId} AS COOPERATOR_ID, c.ESNTL_ID FROM RD_COOPERATOR_PAY a
					JOIN RD_SALES_PROFIT b ON a.COP_ID = b.COP_ID
					JOIN COMTNEMPLYRINFO c ON b.EMPLYR_ID = c.EMPLYR_ID
					WHERE (a.TELEGRAM_NO, a.TRAN_DAY) IN (

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '999'

							UNION ALL

							SELECT TELEGRAM_NO, TRAN_DAY FROM RD_TRANSFER
							WHERE STATUS = '400'
							AND error_code IN ('VTIM', '0011')
					)
					GROUP BY a.COOPERATOR_ID
				)
		FOR UPDATE
	</select>
	<update id="updateTransterProsseceResult" parameterType="egovframework.com.rd.usr.service.vo.DoszResultVO">
		UPDATE RD_TRANSFER
		SET STATUS = #{status}
			<if test='statusCd != null and statusCd != ""'>
			, STATUS_CD = #{statusCd}
			</if>
			<if test='natvTrNo != null and natvTrNo != ""'>
			, NATV_TR_NO = #{natvTrNo}
			</if>
			<if test='sendDt != null and sendDt != ""'>
			, SEND_DT = #{sendDt}
			</if>
			<if test='sendTm != null and sendTm != ""'>
			, SEND_TM = #{sendTm}
			</if>
			<if test='errorCode != null and errorCode != ""'>

			, ERROR_CODE = #{errorCode}
			</if>
			<if test='errorMessage != null and errorMessage != ""'>
			, ERROR_MESSAGE = #{errorMessage}
			</if>
			<if test='trAfterBac != null and trAfterBac != ""'>
			, TR_AFTER_BAC = #{trAfterBac}
			</if>
			, LAST_UPDT_PNTTM = SYSDATE()
			, LAST_UPDUSR_ID = #{lastUpdusrId}

		WHERE TRAN_DAY = #{tranDay}
		AND TELEGRAM_NO = #{telegramNo}
	</update>

	<insert id="insertDoznHistory" parameterType="egovframework.com.rd.usr.service.vo.DoznHistoryVO">
		insert into RD_DOZN_HISTORY (TRAN_DAY, TELEGRAM_NO, URL, SEND_LONGTXT)
		values(#{tranDay}, #{telegramNo}, #{url}, #{sendLongtxt})
	</insert>

	<update id="updateDoznHistory" parameterType="egovframework.com.rd.usr.service.vo.DoznHistoryVO">
		update RD_DOZN_HISTORY
		set RECV_LONGTXT = #{recvLongtxt}
		where TRAN_DAY = #{tranDay} and TELEGRAM_NO = #{telegramNo} and URL = #{url}
	</update>

	<insert id="insertDoznDs" parameterType="egovframework.com.rd.usr.service.vo.DoszDSResultVO">
		INSERT INTO RD_DOZN_DS
		(DS_DT, DS_TM, PAYMENT_SUCC_CNT, PAYMENT_SUCC_AMOUNT, PAYMENT_FAIL_CNT, PAYMENT_FAIL_AMOUNT, DEPOSITOR_SUCC_CNT, DEPOSITOR_TIME_CNT, DEPOSITOR_FAIL_CNT)
		VALUES(#{dsDt}, #{dsTm}, #{paymentSuccCnt}, #{paymentSuccAmount}, #{paymentFailCnt}, #{paymentFailAmount}, #{depositorSuccCnt}, #{depositorTimeCnt}, #{depositorFailCnt})
	</insert>
	<update id="updateDoznDs" parameterType="egovframework.com.rd.usr.service.vo.DoszDSResultVO">
		UPDATE RD_DOZN_DS a, (SELECT tran_day, SUM(if(STATUS=200, 1, 0)) DAON_SUCC_CNT, SUM(if(STATUS=200, amount, 0)) DAON_SUCC_AMOUNT
										, SUM(if(STATUS!=200 OR STATUS IS null, 1, 0)) DAON_FAIL_CNT
										, SUM(if(STATUS!=200 OR STATUS IS null, amount, 0)) DAON_FAIL_AMOUNT
										FROM RD_TRANSFER
										WHERE tran_day = #{dsDt}
										GROUP BY tran_day) b
		SET a.DAON_SUCC_CNT = nvl(b.DAON_SUCC_CNT, 0)
			, a.DAON_SUCC_AMOUNT = nvl(b.DAON_SUCC_AMOUNT, 0)
			, a.DAON_FAIL_CNT = nvl(b.DAON_FAIL_CNT, 0)
			, a.DAON_FAIL_AMOUNT = nvl(b.DAON_FAIL_AMOUNT, 0)
		WHERE a.DS_DT = #{dsDt} and a.DS_TM = #{dsTm}

	</update>
	<select id="selectDoznDs" parameterType="egovframework.com.rd.usr.service.vo.DoszDSResultVO" resultType="egovframework.com.rd.usr.service.vo.DoszDSResultVO">
		SELECT DS_DT, DS_TM, PAYMENT_SUCC_CNT, PAYMENT_SUCC_AMOUNT, PAYMENT_FAIL_CNT, PAYMENT_FAIL_AMOUNT, DEPOSITOR_SUCC_CNT, DEPOSITOR_TIME_CNT, DEPOSITOR_FAIL_CNT
			, DAON_SUCC_CNT, DAON_SUCC_AMOUNT, DAON_FAIL_CNT, DAON_FAIL_AMOUNT, CREAT_DT
		FROM RD_DOZN_DS
		WHERE 1=1
		AND DS_DT BETWEEN #{searchFromDate} and  #{searchToDate}
		ORDER BY DS_DT DESC
	</select>
	<select id="selectProfitList" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO" resultType="egovframework.com.rd.usr.service.vo.ProfitVO">

		SELECT a.PROFIT_ID, a.COOPERATOR_ID, a.MBER_ID, a.GUBUN, a.COST, a.DELIVERY_COST, a.DELIVERY_CNT, a.DELIVERY_DAY, a.DYP_ID, a.WKP_ID, a.FEE_ID, a.RIDER_FEE_ID
		, DATE_FORMAT(a.CREAT_DT, '%Y%m%d') AS CREAT_DT, a.CREAT_ID
		, b.MBER_NM, c.COOPERATOR_NM
		, case when a.gubun = 'C' then '콜수수료' when a.gubun ='E' then '기타수수료' when a.gubun ='D' then '선지급수수료' when a.gubun ='P' then '프로그램료' ELSE '' END GUBUN_NM
		FROM RD_PROFIT a
		LEFT JOIN COMTNGNRLMBER b ON a.mber_id = b.mber_id
		LEFT JOIN RD_COOPERATOR c ON a.cooperator_id = c.COOPERATOR_ID
		where 1=1
			AND a.USE_AT ='Y'

			<if test="searchGubun != 'all'">
			AND a.gubun = #{searchGubun}
			</if>
			<if test='searchCooperatorId != null and searchCooperatorId != "all"'>
			AND a.cooperator_id = #{searchCooperatorId}
			</if>
			<if test="searchNm != null and searchNm != ''">
			AND b.mber_nm like '%' #{searchNm} '%'
			</if>
			AND a.DELIVERY_DAY BETWEEN #{searchFromDate} AND #{searchToDate}
			<if test="searchRegistrationSn != null and searchRegistrationSn != ''">
			AND a.COOPERATOR_ID IN (
				SELECT COOPERATOR_ID from RD_COOPERATOR
				WHERE REGISTRATION_SN = #{searchRegistrationSn}
			)
			</if>
	</select>

	<select id="selectCooperatorProfitList" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO" resultType="egovframework.com.rd.usr.service.vo.ProfitVO">

		SELECT a.coofit_id, a.PROFIT_ID, a.COOPERATOR_ID, a.MBER_ID, a.GUBUN, a.COST, a.DELIVERY_COST, a.DELIVERY_CNT, a.DELIVERY_DAY, a.DYP_ID, a.WKP_ID, a.FEE_ID, a.RIDER_FEE_ID
		, DATE_FORMAT(a.CREAT_DT, '%Y%m%d') AS CREAT_DT, a.CREAT_ID
		, b.MBER_NM, c.COOPERATOR_NM
		, case when a.gubun = 'C' then '콜수수료' when a.gubun ='E' then '기타수수료' when a.gubun ='D' then '선지급수수료' when a.gubun ='B' then '부가세' when a.gubun ='O' then '원천세' when a.gubun ='M' then '관리비' when a.gubun ='S' then '사업주부담고용보험료' when a.gubun ='R' then '사업주부담산재보험료' ELSE '' END GUBUN_NM
		FROM RD_COOPERATOR_PROFIT a
		LEFT JOIN COMTNGNRLMBER b ON a.mber_id = b.mber_id
		LEFT JOIN RD_COOPERATOR c ON a.cooperator_id = c.COOPERATOR_ID
		where 1=1
		AND a.USE_AT ='Y'

			<if test="searchGubun != 'all'">
			AND a.gubun = #{searchGubun}
			</if>
			<if test='searchCooperatorId != null and searchCooperatorId != "all"'>
			AND a.cooperator_id = #{searchCooperatorId}
			</if>
			<if test="searchNm != null and searchNm != ''">
			AND b.mber_nm like '%' #{searchNm} '%'
			</if>
			AND a.DELIVERY_DAY BETWEEN #{searchFromDate} AND #{searchToDate}
			<if test="searchRegistrationSn != null and searchRegistrationSn != ''">
			AND a.COOPERATOR_ID IN (
				SELECT COOPERATOR_ID from RD_COOPERATOR
				WHERE REGISTRATION_SN = #{searchRegistrationSn}
			)
			</if>
			<if test="schAuthorCode == 'ROLE_USER'">
			/* 협력사 조건 */
			AND a.COOPERATOR_ID IN (
				SELECT COOPERATOR_ID FROM RD_COOPERATOR a
				WHERE a.REGISTRATION_SN = #{schIhidNum} AND use_at ='Y'
			)
			</if>
			ORDER BY a.DELIVERY_DAY DESC
	</select>

	<select id="selectSalesProfitList" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO" resultType="egovframework.com.rd.usr.service.vo.ProfitVO">

		SELECT a.SALFIT_ID, a.PROFIT_ID, a.COOPERATOR_ID, a.MBER_ID, a.GUBUN, a.COST, a.DELIVERY_CNT, a.DELIVERY_DAY, a.DYP_ID, a.WKP_ID, a.FEE_ID, a.RIDER_FEE_ID
		, DATE_FORMAT(a.CREAT_DT, '%Y%m%d') AS CREAT_DT, a.CREAT_ID
		, b.MBER_NM, c.COOPERATOR_NM, a.EMPLYR_ID, d.USER_NM AS EMPLYR_NM
		, case when a.gubun = 'C' then '콜수수료' when a.gubun ='E' then '기타수수료' when a.gubun ='D' then '선지급수수료' when a.gubun ='P' then '프로그램료' ELSE '' END GUBUN_NM
		FROM RD_SALES_PROFIT a
		LEFT JOIN COMTNGNRLMBER b ON a.mber_id = b.mber_id
		LEFT JOIN RD_COOPERATOR c ON a.cooperator_id = c.COOPERATOR_ID
		LEFT JOIN COMTNEMPLYRINFO d ON a.EMPLYR_ID = d.EMPLYR_ID
		where 1=1
			AND a.USE_AT ='Y'

			<if test="searchGubun != 'all'">
			AND a.gubun = #{searchGubun}
			</if>
			<if test='searchCooperatorId != null and searchCooperatorId != "all"'>
			AND a.cooperator_id = #{searchCooperatorId}
			</if>
			<if test="searchNm != null and searchNm != ''">
			AND b.mber_nm like '%' #{searchNm} '%'
			</if>
			AND a.DELIVERY_DAY BETWEEN #{searchFromDate} AND #{searchToDate}
			<if test="searchRegistrationSn != null and searchRegistrationSn != ''">
			AND a.COOPERATOR_ID IN (
				SELECT COOPERATOR_ID from RD_COOPERATOR
				WHERE REGISTRATION_SN = #{searchRegistrationSn}
			)
			</if>
			<if test="schAuthorCode == 'ROLE_SALES'">
			/* 영업사원 조건 */
			AND a.COOPERATOR_ID IN (
				SELECT COOPERATOR_ID FROM RD_COOPERATOR_SALES
				WHERE EMPLYR_ID = #{searchId} AND USE_AT ='Y'
			)
			</if>
			<if test='searchSalesId != null and searchSalesId != "all"'>
			AND a.EMPLYR_ID = #{searchSalesId}
			</if>
	</select>

	<select id="cooperatorAblePrice" parameterType="egovframework.com.rd.usr.service.vo.MyInfoVO" resultType="egovframework.com.rd.usr.service.vo.MyInfoVO">
		SELECT tab.cooperator_id, tab.cooperator_nm
		, SUM(day_plus) AS BALANCE_DAY_ABLE_PRICE
		, SUM(day_minus) AS DAY_MINUS
		, SUM(week_plus) - SUM(week_minus) AS BALANCE_WEEK_ABLE_PRICE
		<![CDATA[, if(SUM(week_plus) - SUM(week_minus) < 0 , (SUM(day_plus) - SUM(day_minus) - CEILING(SUM(day_plus)*nvl(a.FEE_ADMINSTRATOR*0.01, 0))) + (SUM(week_plus) - SUM(week_minus)), SUM(day_plus) - SUM(day_minus) - CEILING(SUM(day_plus)*nvl(a.FEE_ADMINSTRATOR*0.01, 0))) AS DAY_ABLE_PRICE
		, if(SUM(week_plus) - SUM(week_minus) < 0 , 0, SUM(week_plus) - SUM(week_minus)) AS WEEK_ABLE_PRICE]]>
		, a.FEE_ADMINSTRATOR, a.FEE_SALESMAN, a.FEE_ID, b.EMPLYR_ID
		FROM (
			SELECT aa.cooperator_id, aa.cooperator_nm
			,sum(if(a.week_yn ='N', if(a.gubun = 'C' OR a.gubun = 'E' OR a.gubun = 'B' OR a.gubun = 'O' OR a.gubun = 'M' OR a.gubun = 'S' OR a.gubun = 'R' OR (a.gubun = 'D' AND c.status_cd = '0000' AND c.STATUS = '200'), cost, 0), 0)) day_plus	/*선지급금은 이체완료건만 산정*/
			,sum(if(a.week_yn ='Y', if(a.gubun = 'C' OR a.gubun = 'E' OR a.gubun = 'B' OR a.gubun = 'O' OR a.gubun = 'M' OR a.gubun = 'S' OR a.gubun = 'R' OR (a.gubun = 'D' AND c.status_cd = '0000' AND c.STATUS = '200'), cost, 0), 0)) week_plus	/*선지급금은 이체완료건만 산정*/
			, 0 day_minus
			, 0 week_minus
			FROM  RD_COOPERATOR aa
			left join RD_COOPERATOR_PROFIT a ON aa.cooperator_id = a.cooperator_id AND a.USE_AT ='Y'
			LEFT JOIN RD_DAY_PAY b  ON a.DYP_ID = b.DYP_ID AND b.USE_AT ='Y'
			LEFT JOIN RD_TRANSFER c ON b.TRAN_DAY = c.TRAN_DAY AND b.TELEGRAM_NO = c.TELEGRAM_NO
			WHERE 1=1
				AND aa.USE_AT = 'Y'
			<if test="schIhidNum != null and schIhidNum != ''">
				AND aa.COOPERATOR_ID IN (
					SELECT COOPERATOR_ID FROM RD_COOPERATOR sub_a
					WHERE sub_a.REGISTRATION_SN = #{schIhidNum} AND use_at ='Y'
				)
			</if>
			<if test="searchCooperatorId != null and searchCooperatorId != ''">
				AND aa.COOPERATOR_ID = #{searchCooperatorId}
			</if>
			GROUP BY aa.cooperator_id

			UNION all

			SELECT aa.cooperator_id, aa.cooperator_nm
			, 0 day_plus
			, 0 week_plus
			, nvl(sum(if(week_yn ='N', a.send_fee+a.send_price, 0)), 0) day_minus
			, nvl(sum(if(week_yn ='Y', a.send_fee+a.send_price+day_fee, 0)), 0) week_minus
			FROM RD_COOPERATOR aa
			left join RD_COOPERATOR_PAY a ON aa.cooperator_id = a.cooperator_id AND a.USE_AT ='Y'
			WHERE 1=1
				AND aa.USE_AT = 'Y'
			<if test="schIhidNum != null and schIhidNum != ''">
				AND aa.COOPERATOR_ID IN (
					SELECT COOPERATOR_ID FROM RD_COOPERATOR sub_a
					WHERE sub_a.REGISTRATION_SN = #{schIhidNum} AND use_at ='Y'
				)
			</if>
			<if test="searchCooperatorId != null and searchCooperatorId != ''">
				AND aa.COOPERATOR_ID = #{searchCooperatorId}
			</if>
			GROUP BY aa.cooperator_id
		) tab
		LEFT JOIN RD_COOPERATOR_FEE a ON tab.COOPERATOR_ID = a.COOPERATOR_ID AND a.use_at ='Y'
		LEFT JOIN RD_COOPERATOR_SALES b ON tab.COOPERATOR_ID = b.COOPERATOR_ID AND b.USE_AT ='Y'
		GROUP by cooperator_id

	</select>
	<select id="salesAblePrice" parameterType="egovframework.com.rd.usr.service.vo.MyInfoVO" resultType="egovframework.com.rd.usr.service.vo.MyInfoVO">

		SELECT SUM(day_plus) - SUM(day_minus) AS SALES_ABLE_PRICE
		FROM (
			SELECT NVL(sum(if(a.gubun = 'C' OR a.gubun = 'P' OR (a.gubun = 'D' AND c.status_cd = '0000' AND c.STATUS = '200'), cost, 0)), 0) DAY_PLUS	/*선지급금은 이체완료건만 산정*/
			, 0 DAY_MINUS
			FROM RD_SALES_PROFIT a
			LEFT JOIN RD_DAY_PAY b  ON a.DYP_ID = b.DYP_ID AND b.USE_AT ='Y'
			LEFT JOIN RD_TRANSFER c ON b.TRAN_DAY = c.TRAN_DAY AND b.TELEGRAM_NO = c.TELEGRAM_NO
			JOIN COMTNEMPLYRINFO d ON a.EMPLYR_ID = d.EMPLYR_ID
			JOIN COMTNEMPLYRSCRTYESTBS e ON d.ESNTL_ID = e.SCRTY_DTRMN_TRGET_ID
			WHERE 1=1
				AND a.USE_AT = 'Y'
				AND a.EMPLYR_ID = #{emplyrId}
				AND e.AUTHOR_CODE = 'ROLE_SALES'

			UNION all

			SELECT NVL(sum(if(a.gubun = 'C' OR a.gubun = 'P' OR (a.gubun = 'D' AND c.status_cd = '0000' AND c.STATUS = '200'), cost, 0)), 0) DAY_PLUS	/*선지급금은 이체완료건만 산정*/
			, 0 DAY_MINUS
			FROM RD_SALES_PROFIT a
			JOIN RD_COOPERATOR_PAY b  ON a.COP_ID = b.COP_ID AND b.USE_AT ='Y'
			LEFT JOIN RD_TRANSFER c ON b.TRAN_DAY = c.TRAN_DAY AND b.TELEGRAM_NO = c.TELEGRAM_NO
			JOIN COMTNEMPLYRINFO d ON a.EMPLYR_ID = d.EMPLYR_ID
			JOIN COMTNEMPLYRSCRTYESTBS e ON d.ESNTL_ID = e.SCRTY_DTRMN_TRGET_ID
			WHERE 1=1
				AND a.USE_AT = 'Y'
				AND a.EMPLYR_ID = #{emplyrId}
				AND e.AUTHOR_CODE = 'ROLE_SALES'


			UNION all

			SELECT 0 DAY_PLUS
			, NVL(SUM( a.send_fee+a.send_price), 0) DAY_MINUS
			FROM RD_SALES_PAY a
			JOIN COMTNEMPLYRINFO d ON a.EMPLYR_ID = d.EMPLYR_ID
			JOIN COMTNEMPLYRSCRTYESTBS e ON d.ESNTL_ID = e.SCRTY_DTRMN_TRGET_ID
			WHERE 1=1
				AND a.USE_AT = 'Y'
				AND a.EMPLYR_ID = #{emplyrId}
				AND e.AUTHOR_CODE = 'ROLE_SALES'
		) tab
	</select>

	<insert id="isnertCooperatorPay" parameterType="egovframework.com.rd.usr.service.vo.CooperatorPayVO">
		INSERT INTO RD_COOPERATOR_PAY
		(COP_ID, COOPERATOR_ID, DAY_FEE, SEND_FEE, SEND_PRICE, TRAN_DAY, TELEGRAM_NO, WEEK_YN, USE_AT, CREAT_DT, CREAT_ID)
		VALUES(#{copId}, #{cooperatorId}, #{dayFee}, #{sendFee}, #{sendPrice}, #{tranDay}, #{telegramNo}, #{weekYn}, #{useAt}, SYSDATE(), #{creatId})
	</insert>

	<insert id="isnertSalesPay" parameterType="egovframework.com.rd.usr.service.vo.CooperatorPayVO">
		INSERT INTO RD_SALES_PAY
		(SAP_ID, EMPLYR_ID, SEND_FEE, SEND_PRICE, TRAN_DAY, TELEGRAM_NO, USE_AT, CREAT_DT, CREAT_ID)
		VALUES(#{sapId}, #{emplyrId}, #{sendFee}, #{sendPrice}, #{tranDay}, #{telegramNo}, #{useAt}, SYSDATE(), #{creatId})
	</insert>

	<update id="updateCooperatorPayByTransfer" parameterType="egovframework.com.rd.usr.service.vo.DoszTransferVO">
		UPDATE RD_COOPERATOR_PAY
		set USE_AT = 'N'
		WHERE TRAN_DAY = #{tranDay} AND  TELEGRAM_NO = #{telegram_no} AND USE_AT ='Y'
	</update>

	<update id="updateSalesPayByTransfer" parameterType="egovframework.com.rd.usr.service.vo.DoszTransferVO">
		UPDATE RD_SALES_PAY
		set USE_AT = 'N'
		WHERE TRAN_DAY = #{tranDay} AND  TELEGRAM_NO = #{telegram_no} AND USE_AT ='Y'
	</update>
	<select id="selectForUPdateBalanceByTran" parameterType="egovframework.com.rd.usr.service.vo.DoszTransferVO" resultType="egovframework.com.rd.usr.service.vo.BalanceVO">
		SELECT * FROM RD_BALANCE
		WHERE (COOPERATOR_ID, ESNTL_ID) IN (
		SELECT COOPERATOR_ID, #{cooperatorMberId} AS ESNTL_ID FROM RD_COOPERATOR_PAY
				WHERE TRAN_DAY = #{tranDay} AND  TELEGRAM_NO = #{telegram_no} AND USE_AT ='Y'
				)
		FOR UPDATE
	</select>
	<select id="selectForUPdateSalesBalanceByTran" parameterType="egovframework.com.rd.usr.service.vo.DoszTransferVO" resultType="egovframework.com.rd.usr.service.vo.BalanceVO">
		SELECT * FROM RD_BALANCE
		WHERE (COOPERATOR_ID, ESNTL_ID) IN (
		SELECT #{cooperatorMberId} AS COOPERATOR_ID, b.ESNTL_ID FROM RD_SALES_PAY a, COMTNEMPLYRINFO b
				WHERE a.EMPLYR_ID = b.EMPLYR_ID
				AND TRAN_DAY = #{tranDay} AND  TELEGRAM_NO = #{telegram_no} AND USE_AT ='Y'
				)
		FOR UPDATE
	</select>
	<update id="updateBalanceCooperatorPayByTransfer" parameterType="egovframework.com.rd.usr.service.vo.DoszTransferVO">
		UPDATE RD_BALANCE a, (
				SELECT COOPERATOR_ID, #{cooperatorMberId} AS ESNTL_ID, SEND_FEE+SEND_PRICE AS SUM_COST, week_yn
				from RD_COOPERATOR_PAY
				WHERE TRAN_DAY = #{tranDay} AND  TELEGRAM_NO = #{telegram_no} AND USE_AT ='Y'
		)b
		SET BALANCE1 = BALANCE1 + if(week_yn =  'Y', SUM_COST, 0 )
		WHERE a.COOPERATOR_ID = b.COOPERATOR_ID
		AND a.ESNTL_ID = b.ESNTL_ID
	</update>

	<update id="updateBalanceSalesPayByTransfer" parameterType="egovframework.com.rd.usr.service.vo.DoszTransferVO">
		UPDATE RD_BALANCE a, (
				SELECT #{cooperatorMberId} AS COOPERATOR_ID, b.ESNTL_ID , SEND_FEE+SEND_PRICE AS SUM_COST
				FROM RD_SALES_PAY a
				JOIN COMTNEMPLYRINFO b ON a.EMPLYR_ID = b.EMPLYR_ID
				WHERE TRAN_DAY = #{tranDay} AND  TELEGRAM_NO = #{telegram_no} AND USE_AT ='Y'
		)b
		SET BALANCE1 = BALANCE1 + SUM_COST
		WHERE a.COOPERATOR_ID = b.COOPERATOR_ID
		AND a.ESNTL_ID = b.ESNTL_ID
	</update>
	<select id="selectCooperatorPayList" parameterType="egovframework.com.rd.usr.service.vo.CooperatorPayVO" resultType="egovframework.com.rd.usr.service.vo.CooperatorPayVO">
		SELECT aa.cooperator_nm
		, aa.COOPERATOR_ID
		, a.COP_ID
		, a.send_fee, a.send_price, a.day_fee
		, case when b.STATUS='200' then '이체' when b.STATUS= '999' then '처리중' when b.STATUS= '400' AND b.error_code='VTIM' then '처리중' when b.STATUS= '400' AND b.error_code='0011' then '처리중' ELSE '실패' end  AS STATUS_NM
		, b.TRAN_DAY , b.RV_ACCOUNT, b.STATUS, b.STATUS_cd, b.error_code
		, e.CD_NM AS RV_BANK_NM
		, b.SEND_DT, b.SEND_TM, b.CREAT_DT, b.error_message
		FROM RD_COOPERATOR aa
		JOIN RD_COOPERATOR_PAY a ON aa.cooperator_id = a.cooperator_id
		LEFT JOIN RD_TRANSFER b ON a.TRAN_DAY = b.TRAN_DAY AND a.TELEGRAM_NO = b.TELEGRAM_NO
		LEFT JOIN RD_CD e ON b.RV_BANK_CODE = e.CD AND e.CD_GROUP ='BANK_CD'
		WHERE 1=1

				<if test="cooperatorId != null and cooperatorId != ''">
				AND aa.COOPERATOR_ID = #{cooperatorId}
				</if>

				<if test='searchCooperatorId != null and searchCooperatorId != "all"'>
				AND aa.cooperator_id = #{searchCooperatorId}
				</if>
				<if test='searchFromDate != null and searchFromDate != "all" and searchFromDate != null and searchFromDate != "all"'>
				AND DATE_FORMAT(a.CREAT_DT,'%Y%m%d') BETWEEN #{searchFromDate} AND #{searchToDate}
				</if>
				<if test="searchRegistrationSn != null and searchRegistrationSn != ''">
				AND aa.COOPERATOR_ID IN (
					SELECT COOPERATOR_ID from RD_COOPERATOR
					WHERE REGISTRATION_SN = #{searchRegistrationSn}
				)
				</if>
			<if test="schAuthorCode == 'ROLE_USER'">
			/* 협력사 조건 */
			AND aa.USE_AT = 'Y'
			AND aa.COOPERATOR_ID IN (
				SELECT COOPERATOR_ID FROM RD_COOPERATOR sub_a
					WHERE sub_a.REGISTRATION_SN = #{schIhidNum} AND use_at ='Y'
			)
			</if>
		ORDER BY a.CREAT_DT desc
	</select>

	<select id="selectSalesPayList" parameterType="egovframework.com.rd.usr.service.vo.CooperatorPayVO" resultType="egovframework.com.rd.usr.service.vo.CooperatorPayVO">
		SELECT a.SAP_ID
		, a.send_fee, a.send_price
		, case when b.STATUS='200' then '이체' when b.STATUS= '999' then '처리중' when b.STATUS= '400' AND b.error_code='VTIM' then '처리중' when b.STATUS= '400' AND b.error_code='0011' then '처리중' ELSE '실패' end  AS STATUS_NM
		, b.TRAN_DAY , b.RV_ACCOUNT, b.STATUS, b.STATUS_cd, b.error_code
		, e.CD_NM AS RV_BANK_NM
		, b.SEND_DT, b.SEND_TM, b.CREAT_DT, b.error_message
		FROM RD_SALES_PAY a
		LEFT JOIN RD_TRANSFER b ON a.TRAN_DAY = b.TRAN_DAY AND a.TELEGRAM_NO = b.TELEGRAM_NO
		LEFT JOIN RD_CD e ON b.RV_BANK_CODE = e.CD AND e.CD_GROUP ='BANK_CD'
		WHERE 1=1

				<if test='searchFromDate != null and searchFromDate != "all" and searchFromDate != null and searchFromDate != "all"'>
				AND DATE_FORMAT(a.CREAT_DT,'%Y%m%d') BETWEEN #{searchFromDate} AND #{searchToDate}
				</if>
			<if test="schAuthorCode == 'ROLE_USER'">
			AND 1=0
			</if>
			<if test="schAuthorCode == 'ROLE_SALES'">
			AND a.EMPLYR_ID = #{emplyrId}
			</if>
		ORDER BY a.CREAT_DT desc
	</select>


	<select id="selectProfitFeeCoop" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO"  resultType="egovframework.com.rd.usr.service.vo.CooperatorVO">
		SELECT a.COOPERATOR_ID, COOPERATOR_NM, REGISTRATION_SN, COMPANY_NM, REGISTRATION_NM, CEO_NM, a.USE_AT, DATE_FORMAT(b.CREAT_DT, '%Y%m%d') AS CREAT_DT, a.CREAT_ID, 'R' GUBUN
		, cp.FEE_ID, FEE_ADMINSTRATOR, FEE_SALESMAN, FEE_COOPERATOR, FEE_EMPLOYMENT_INSURANCE, FEE_INDUSTRIAL_INSURANCE, FEE_WITHHOLDING_TAX, FEE_TIME_INSURANCE, FEE_CALL, FEE_COOPERATOR_CALL, FEE_PROGRAM, FEE_PROGRAM_SALESMAN
		FROM RD_PROFIT cp
		left join RD_COOPERATOR a ON cp.COOPERATOR_ID = a.COOPERATOR_ID
		LEFT JOIN RD_COOPERATOR_FEE b ON cp.fee_id = b.fee_id
		WHERE 1 = 1
			AND cp.profit_id = #{profitId}
	</select>

	<select id="selectProfitFeeRider" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO" resultType="egovframework.com.rd.usr.service.vo.CooperatorVO">

		SELECT usr.mber_id, usr.mber_nm, usr.MBTLNUM
		, NVL(fee.FEE_EMPLOYMENT_INSURANCE, b.FEE_EMPLOYMENT_INSURANCE) AS FEE_EMPLOYMENT_INSURANCE
		, NVL(fee.FEE_INDUSTRIAL_INSURANCE, b.FEE_INDUSTRIAL_INSURANCE) AS FEE_INDUSTRIAL_INSURANCE
		, NVL(fee.FEE_WITHHOLDING_TAX, b.FEE_WITHHOLDING_TAX) AS FEE_WITHHOLDING_TAX
		, NVL(fee.FEE_TIME_INSURANCE, b.FEE_TIME_INSURANCE) AS FEE_TIME_INSURANCE
		, NVL(fee.FEE_CALL, b.FEE_CALL) AS FEE_CALL

		FROM RD_PROFIT cp
		LEFT JOIN COMTNGNRLMBER usr ON cp.mber_id = usr.mber_id
		LEFT JOIN RD_RIDER_FEE fee ON cp.COOPERATOR_ID = fee.COOPERATOR_ID AND cp.MBER_ID = fee.MBER_ID AND cp.RIDER_FEE_ID = fee.RIDER_FEE_ID
		LEFT JOIN RD_COOPERATOR_FEE b ON cp.COOPERATOR_ID = b.COOPERATOR_ID AND cp.FEE_ID = b.FEE_ID
		WHERE 1 = 1
			AND cp.profit_id = #{profitId}
	</select>
	<select id="selectProfitBase" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO" resultType="egovframework.com.rd.usr.service.vo.ProfitVO">
		SELECT a.GUBUN
		, case when a.gubun = 'C' then '콜수수료' when a.gubun ='E' then '기타수수료' when a.gubun ='D' then '선지급수수료' when a.gubun ='P' then '프로그램료' ELSE '' END GUBUN_NM
		, case when a.GUBUN = 'C' or a.GUBUN = 'P' then a.DELIVERY_COST when a.GUBUN = 'D' and a.DYP_ID is not null then b.SEND_PRICE when a.GUBUN = 'D' and a.cop_id is not null then c.SEND_PRICE ELSE 0 END cost
		, a.DELIVERY_CNT, a.DELIVERY_DAY, a.DYP_ID, a.COP_ID
		FROM RD_PROFIT a
		LEFT JOIN RD_DAY_PAY b ON a.DYP_ID = b.DYP_ID
		LEFT JOIN RD_COOPERATOR_PAY c ON a.COP_ID = c.COP_ID
		WHERE 1 = 1
			AND a.PROFIT_ID = #{profitId}
	</select>


	<select id="selectCoopProfitFeeCoop" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO"  resultType="egovframework.com.rd.usr.service.vo.CooperatorVO">
		SELECT a.COOPERATOR_ID, COOPERATOR_NM, REGISTRATION_SN, COMPANY_NM, REGISTRATION_NM, CEO_NM, a.USE_AT, DATE_FORMAT(b.CREAT_DT, '%Y%m%d') AS CREAT_DT, a.CREAT_ID, 'R' GUBUN
		, cp.FEE_ID, FEE_ADMINSTRATOR, FEE_SALESMAN, FEE_COOPERATOR, FEE_EMPLOYMENT_INSURANCE, FEE_INDUSTRIAL_INSURANCE, FEE_WITHHOLDING_TAX, FEE_TIME_INSURANCE, FEE_CALL, FEE_COOPERATOR_CALL, FEE_PROGRAM, FEE_PROGRAM_SALESMAN
		FROM RD_COOPERATOR_PROFIT cp
		left join RD_COOPERATOR a ON cp.COOPERATOR_ID = a.COOPERATOR_ID
		LEFT JOIN RD_COOPERATOR_FEE b ON cp.fee_id = b.fee_id
		WHERE 1 = 1
			AND cp.coofit_id = #{coofitId}
	</select>

	<select id="selectCoopProfitFeeRider" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO" resultType="egovframework.com.rd.usr.service.vo.CooperatorVO">

		SELECT usr.mber_id, usr.mber_nm, usr.MBTLNUM
		, NVL(fee.FEE_EMPLOYMENT_INSURANCE, b.FEE_EMPLOYMENT_INSURANCE) AS FEE_EMPLOYMENT_INSURANCE
		, NVL(fee.FEE_INDUSTRIAL_INSURANCE, b.FEE_INDUSTRIAL_INSURANCE) AS FEE_INDUSTRIAL_INSURANCE
		, NVL(fee.FEE_WITHHOLDING_TAX, b.FEE_WITHHOLDING_TAX) AS FEE_WITHHOLDING_TAX
		, NVL(fee.FEE_TIME_INSURANCE, b.FEE_TIME_INSURANCE) AS FEE_TIME_INSURANCE
		, NVL(fee.FEE_CALL, b.FEE_CALL) AS FEE_CALL

		FROM RD_COOPERATOR_PROFIT cp
		LEFT JOIN COMTNGNRLMBER usr ON cp.mber_id = usr.mber_id
		LEFT JOIN RD_RIDER_FEE fee ON cp.COOPERATOR_ID = fee.COOPERATOR_ID AND cp.MBER_ID = fee.MBER_ID AND cp.RIDER_FEE_ID = fee.RIDER_FEE_ID
		LEFT JOIN RD_COOPERATOR_FEE b ON cp.COOPERATOR_ID = b.COOPERATOR_ID AND cp.FEE_ID = b.FEE_ID
		WHERE 1 = 1
			AND cp.coofit_id = #{coofitId}
	</select>
	<select id="selectCoopProfitBase" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO" resultType="egovframework.com.rd.usr.service.vo.ProfitVO">
		SELECT a.GUBUN
		, case when a.gubun = 'C' then '콜수수료' when a.gubun ='E' then '기타수수료' when a.gubun ='D' then '선지급수수료' ELSE '' END GUBUN_NM
		, case when a.GUBUN = 'C' then a.DELIVERY_COST when a.GUBUN = 'D' then b.SEND_PRICE ELSE 0 END cost
		, a.DELIVERY_CNT, a.DELIVERY_DAY
		FROM RD_COOPERATOR_PROFIT a
		LEFT JOIN RD_DAY_PAY b ON a.DYP_ID = b.DYP_ID
		WHERE 1 = 1
			AND a.coofit_id = #{coofitId}
	</select>


	<select id="selectSalesProfitFeeCoop" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO"  resultType="egovframework.com.rd.usr.service.vo.CooperatorVO">
		SELECT a.COOPERATOR_ID, COOPERATOR_NM, REGISTRATION_SN, COMPANY_NM, REGISTRATION_NM, CEO_NM, a.USE_AT, DATE_FORMAT(b.CREAT_DT, '%Y%m%d') AS CREAT_DT, a.CREAT_ID, 'R' GUBUN
		, cp.FEE_ID, FEE_ADMINSTRATOR, FEE_SALESMAN, FEE_COOPERATOR, FEE_EMPLOYMENT_INSURANCE, FEE_INDUSTRIAL_INSURANCE, FEE_WITHHOLDING_TAX, FEE_TIME_INSURANCE, FEE_CALL, FEE_COOPERATOR_CALL, FEE_PROGRAM, FEE_PROGRAM_SALESMAN
		FROM RD_SALES_PROFIT cp
		left join RD_COOPERATOR a ON cp.COOPERATOR_ID = a.COOPERATOR_ID
		LEFT JOIN RD_COOPERATOR_FEE b ON cp.fee_id = b.fee_id
		WHERE 1 = 1
			AND cp.salfit_id = #{salfitId}
	</select>

	<select id="selectSalesProfitFeeRider" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO" resultType="egovframework.com.rd.usr.service.vo.CooperatorVO">

		SELECT usr.mber_id, usr.mber_nm, usr.MBTLNUM
		, NVL(fee.FEE_EMPLOYMENT_INSURANCE, b.FEE_EMPLOYMENT_INSURANCE) AS FEE_EMPLOYMENT_INSURANCE
		, NVL(fee.FEE_INDUSTRIAL_INSURANCE, b.FEE_INDUSTRIAL_INSURANCE) AS FEE_INDUSTRIAL_INSURANCE
		, NVL(fee.FEE_WITHHOLDING_TAX, b.FEE_WITHHOLDING_TAX) AS FEE_WITHHOLDING_TAX
		, NVL(fee.FEE_TIME_INSURANCE, b.FEE_TIME_INSURANCE) AS FEE_TIME_INSURANCE
		, NVL(fee.FEE_CALL, b.FEE_CALL) AS FEE_CALL

		FROM RD_SALES_PROFIT cp
		LEFT JOIN COMTNGNRLMBER usr ON cp.mber_id = usr.mber_id
		LEFT JOIN RD_RIDER_FEE fee ON cp.COOPERATOR_ID = fee.COOPERATOR_ID AND cp.MBER_ID = fee.MBER_ID AND cp.RIDER_FEE_ID = fee.RIDER_FEE_ID
		LEFT JOIN RD_COOPERATOR_FEE b ON cp.COOPERATOR_ID = b.COOPERATOR_ID AND cp.FEE_ID = b.FEE_ID
		WHERE 1 = 1
			AND cp.salfit_id = #{salfitId}
	</select>
	<select id="selectSalesProfitBase" parameterType="egovframework.com.rd.usr.service.vo.ProfitVO" resultType="egovframework.com.rd.usr.service.vo.ProfitVO">
		SELECT a.GUBUN
		, case when a.gubun ='E' then '기타수수료' when a.gubun ='D' then '선지급수수료' ELSE '' END GUBUN_NM
		, case when a.GUBUN = 'D' and a.DYP_ID IS NOT NULL then b.SEND_PRICE WHEN a.GUBUN = 'D' and a.COP_ID IS NOT NULL THEN c.SEND_PRICE ELSE 0 END cost
		, a.DELIVERY_CNT, a.DELIVERY_DAY
		FROM RD_SALES_PROFIT a
		LEFT JOIN RD_DAY_PAY b ON a.DYP_ID = b.DYP_ID
		LEFT JOIN RD_COOPERATOR_PAY c ON a.COP_ID = c.COP_ID
		WHERE 1 = 1
			AND a.salfit_id =  #{salfitId}
	</select>
	<insert id="insertKko" parameterType="egovframework.com.rd.usr.service.vo.KkoVO">
		INSERT INTO RD_KKO
		(KKO_ID, UP_KKO_ID, MBER_ID, GUBUN, MBTLNUM, URL, TEMPLATE_CODE, SEND_ACCESS_TOKEN, SEND_REFRESH_TOKEN, SEND_LONGTXT, RECV_LONGTXT
			, CODE, USER_KEY, STATUS, KAORSLTCODE, BIGO, SEND_DT, CREAT_DT, CREAT_ID)
		values(#{kkoId}, #{upKkoId}, #{mberId}, #{gubun}, #{mbtlnum}, #{url}, #{templateCode}, #{sendAccessToken}, #{sendRefreshToken}, #{sendLongtxt}, #{recvLongtxt}
			, #{code}, #{userKey}, #{status}, #{kaorsltcode}, #{bigo}, #{sendDt},SYSDATE(), #{creatId})
	</insert>
	<update id="updateKko" parameterType="egovframework.com.rd.usr.service.vo.KkoVO">
		UPDATE RD_KKO
		SET CODE = #{code}
			<if test='sendAccessToken != null and sendAccessToken != ""'>
			, SEND_ACCESS_TOKEN = #{sendAccessToken}
			</if>
			<if test='sendRefreshToken != null and sendRefreshToken != ""'>
			, SEND_REFRESH_TOKEN = #{sendRefreshToken}
			</if>
			<if test='recvLongtxt != null and recvLongtxt != ""'>
			, RECV_LONGTXT = #{recvLongtxt}
			</if>
			<if test='referenceKey != null and referenceKey != ""'>
			, REFERENCE_KEY = #{referenceKey}
			</if>
			<if test='userKey != null and userKey != ""'>
			, USER_KEY = #{userKey}
			</if>
			<if test='status != null and status != ""'>
			, STATUS = #{status}
			</if>
			<if test='kaorsltcode != null and kaorsltcode != ""'>
			, KAORSLTCODE = #{kaorsltcode}
			</if>
			<if test='bigo != null and bigo != ""'>
			, BIGO = #{bigo}
			</if>
		where KKO_ID = #{kkoId}
	</update>
	<update id="updateFailKko" parameterType="egovframework.com.rd.usr.service.vo.KkoVO">
		UPDATE RD_KKO
		SET CODE = #{code}
			, BIGO = #{bigo}
		where UP_KKO_ID = #{upKkoId}
	</update>
	<update id="updateKkoUsr" parameterType="egovframework.com.rd.usr.service.vo.KkoVO">
		UPDATE RD_KKO
		SET BIGO = #{bigo}
		, REFERENCE_KEY = #{referenceKey}
		, USER_KEY = #{userKey}
		WHERE UP_KKO_ID = #{upKkoId}
		AND MBTLNUM = #{mbtlnum}
	</update>
	<select id="selectKkoProsseceResult" resultType="egovframework.com.rd.usr.service.vo.KkoVO">
		SELECT * FROM RD_KKO
		WHERE GUBUN ='2'
			AND USER_KEY IS NOT NULL
			AND SEND_ACCESS_TOKEN IS NOT NULL
			AND SEND_REFRESH_TOKEN IS NOT NULL
			AND (STATUS is null or STATUS != '3')
	</select>
	<update id="updateKkoReport" parameterType="egovframework.com.rd.usr.service.vo.KkoVO">
		UPDATE RD_KKO
		SET BIGO = #{bigo}
		, STATUS = #{status}
		, KAORSLTCODE = #{kaorsltcode}
		, RECV_LONGTXT = #{recvLongtxt}
		WHERE REFERENCE_KEY = #{referenceKey}
		AND USER_KEY = #{userKey}
	</update>
	<select id="selectKkoList" parameterType="egovframework.com.rd.usr.service.vo.KkoVO" resultType="egovframework.com.rd.usr.service.vo.KkoVO">
		<if test="schIdx !=0 and schPagePerCnt != 0">
		SELECT * FROM (
			SELECT ROWNUM() RN,m.*
			FROM (
		</if>
				WITH RECURSIVE cte AS (
					SELECT 1 AS LV, a.KKO_ID AS FIX, a.*
					FROM RD_KKO a
					WHERE a.UP_KKO_ID IS NULL

						 UNION ALL

					SELECT 1+cte.LV AS LV, a.UP_KKO_ID AS FIX, a.*
					FROM RD_KKO a
					INNER JOIN cte ON a.UP_KKO_ID = cte.KKO_ID
				)
				SELECT cte.*, a.MBER_NM, b.CD_NM, c.CD_NM AS TEMBLATE_NM
				FROM cte
				LEFT JOIN COMTNGNRLMBER a ON cte.MBER_ID = a.MBER_ID
				LEFT JOIN RD_CD b ON cte.KAORSLTCODE = b.CD AND b.CD_GROUP = 'KKO_CD'
				LEFT JOIN RD_CD c ON cte.TEMPLATE_CODE = c.CD AND c.CD_GROUP = 'KKO_TP'

				WHERE 1=1
					AND SEND_DT BETWEEN #{searchFromDate} AND #{searchToDate}
					<if test='searchGubun != null and searchGubun != "all"'>
					AND GUBUN = #{searchGubun}
					</if>
				ORDER BY FIX DESC, lv
		<if test="schIdx !=0 and schPagePerCnt != 0">
			) m
		) m
		<![CDATA[WHERE RN > #{schIdx}*#{schPagePerCnt} -#{schPagePerCnt} AND RN <= #{schIdx}*#{schPagePerCnt}]]>
		</if>

	</select>

	<select id="selectKkoListCnt" parameterType="egovframework.com.rd.usr.service.vo.KkoVO" resultType = "egovframework.com.rd.usr.service.vo.KkoVO">

				WITH RECURSIVE cte AS (
					SELECT 1 AS LV, a.KKO_ID AS FIX, a.*
					FROM RD_KKO a
					WHERE a.UP_KKO_ID IS NULL

						 UNION ALL

					SELECT 1+cte.LV AS LV, a.UP_KKO_ID AS FIX, a.*
					FROM RD_KKO a
					INNER JOIN cte ON a.UP_KKO_ID = cte.KKO_ID
				)
				SELECT COUNT(cte.KKO_ID) TOTAL_CNT
				FROM cte

				WHERE 1=1
					AND SEND_DT BETWEEN #{searchFromDate} AND #{searchToDate}
					<if test='searchGubun != null and searchGubun != "all"'>
					AND GUBUN = #{searchGubun}
					</if>
	</select>

	<select id="selectBalanceConfirmTarget" parameterType="egovframework.com.rd.usr.service.vo.Sch" resultType="egovframework.com.rd.usr.service.vo.BalanceVO">
		SELECT b.COOPERATOR_ID, b.MBER_ID, c.ESNTL_ID
		FROM RD_COOPERATOR a
		LEFT JOIN RD_COOPERATOR_RIDER_CONNECT b ON a.COOPERATOR_ID = b.COOPERATOR_ID
		JOIN COMTNGNRLMBER c ON b.MBER_ID = c.MBER_ID
		WHERE a.USE_AT = 'Y'
		AND b.USE_AT ='Y'

		UNION ALL

		SELECT COOPERATOR_ID, #{cooperatorMberId} AS MBER_ID, #{cooperatorMberId} AS ESNTL_ID
		FROM RD_COOPERATOR
		WHERE USE_AT = 'Y'
		UNION ALL

		SELECT #{cooperatorMberId} AS COOPERATOR_ID, a.EMPLYR_ID AS MBER_ID, a.ESNTL_ID
		FROM COMTNEMPLYRINFO a
		JOIN COMTNEMPLYRSCRTYESTBS b ON a.ESNTL_ID = b.SCRTY_DTRMN_TRGET_ID AND b.author_code ='ROLE_SALES'
	</select>
	<insert id="insertBalanceConfirm" parameterType="egovframework.com.rd.usr.service.vo.BalanceVO">
		INSERT INTO RD_BALANCE_CONFIRM
		(COOPERATOR_ID, ESNTL_ID, DAY, BALANCE0, BALANCE1, ABLE_BALANCE0, ABLE_BALANCE1)
		VALUES(#{cooperatorId}, #{esntlId}, #{day}, #{balance0}, #{balance1}, #{ableBalance0}, #{ableBalance1})
	</insert>
	<select id="selectWeekPayByMberId" parameterType="egovframework.com.rd.usr.service.vo.WeekPayVO" resultType="egovframework.com.rd.usr.service.vo.WeekRiderInfoVO">
		SELECT a.ACCOUNTS_ST_DT, a.ACCOUNTS_ED_DT
		, b.MBER_ID, b.MBER_NM, b.CNT, b.DELIVERY_COST, b.ADD_COST, b.SUM_COST, b.TIME_INSURANCE, b.NECESSARY_EXPENSES, b.PAY, b.OWNER_EMPLOYMENT_INSURANCE, b.RIDER_EMPLOYMENT_INSURANCE
		, b.OWNER_INDUSTRIAL_INSURANCE, b.RIDER_INDUSTRIAL_INSURANCE, b.WITHHOLDING_TAX_INSURANCE_SUM, b.OWNER_EMPLOYMENT_INSURANCE_ACCOUNTS, b.RIDER_EMPLOYMENT_INSURANCE_ACCOUNTS
		, b.SUM_EMPLOYMENT_INSURANCE_ACCOUNTS, b.OWNER_INDUSTRIAL_INSURANCE_ACCOUNTS, b.RIDER_INDUSTRIAL_INSURANCE_ACCOUNTS, b.SUM_INDUSTRIAL_INSURANCE_ACCOUNTS, b.OPERATING_COST
		, b.ACCOUNTS_COST, b.INCOME_TAX, b.RESIDENCE_TAX, b.WITHHOLDING_TAX, b.GIVE_PAY, b.OPERATING_COST_ADD,  DATE_FORMAT(b.CREAT_DT, '%Y%m%d') AS CREAT_DT
		, c.DAY_FEE_COST, c.SEND_FEE_COST, c.SEND_PRICE_COST, c.ETC_PRICE_COST
		FROM RD_WEEK_INFO_OUT_RIDER a
		JOIN RD_WEEK_RIDER_INFO_OUT_RIDER b ON a.WEEK_ID = b.WEEK_ID
		LEFT JOIN (

			SELECT  b.WEEK_ID, SUM(if( d.ETC_ID IS NULL, NVL(d.DAY_FEE, 0), 0)) AS DAY_FEE_COST	-- 선지급수수료
			, SUM(if( d.ETC_ID IS NULL, NVL(d.SEND_FEE, 0), 0)) AS SEND_FEE_COST	-- 선지급이체수수료
			, SUM(if( d.ETC_ID IS NULL, NVL(d.SEND_PRICE, 0), 0)) AS SEND_PRICE_COST	-- 선지급금

			, SUM(if( d.ETC_ID IS NOT NULL, NVL(d.SEND_PRICE, 0), 0)) AS ETC_PRICE_COST

			, SUM(NVL(d.DAY_FEE, 0)+NVL(d.SEND_FEE,0)+NVL(d.SEND_PRICE,0)) SEND_PRICE


			FROM RD_WEEK_INFO_OUT_RIDER b
			JOIN RD_WEEK_RIDER_INFO_OUT_RIDER c ON b.WEEK_ID = c.WEEK_ID
			LEFT JOIN RD_DAY_PAY d ON b.WEEK_ID = d.WEEK_ID AND d.IO_GUBUN = '2' AND c.MBER_ID = d.MBER_ID AND d.week_YN ='Y'
			WHERE b.COOPERATOR_ID = #{cooperatorId} AND c.mber_id = #{mberId}
			AND (b.ACCOUNTS_ST_DT BETWEEN #{searchFromDate} AND #{searchToDate} or b.ACCOUNTS_ED_DT BETWEEN #{searchFromDate} AND #{searchToDate})


			GROUP BY b.WEEK_ID
		)c ON a.WEEK_ID = c.WEEK_ID
		WHERE 1 = 1
			AND a.COOPERATOR_ID = #{cooperatorId} AND b.mber_id = #{mberId}
			AND (a.ACCOUNTS_ST_DT BETWEEN #{searchFromDate} AND #{searchToDate} or a.ACCOUNTS_ED_DT BETWEEN #{searchFromDate} AND #{searchToDate})
	</select>

	<select id="selectAllPayList" parameterType="egovframework.com.rd.usr.service.vo.HistoryVO" resultType="egovframework.com.rd.usr.service.vo.HistoryVO">
		SELECT *
		FROM (
				SELECT case when sub_tab.gubun = '1' then '라이더선지급'
							when sub_tab.gubun = '2' then '라이더확정지급'
							when sub_tab.gubun = '3' then '협력사출금'
							when sub_tab.gubun = '4' then '영업사원출금'
							ELSE '' END AS GUBUN_NM
					, sub_tab.*
					, case when sub_tab.gubun = '1' then a.MBER_NM
							when sub_tab.gubun = '2' then a.MBER_NM
							when sub_tab.gubun = '3' then c.COOPERATOR_NM
							when sub_tab.gubun = '4' then b.USER_NM
							ELSE '' END AS NM
					FROM (
						SELECT CASE WHEN b.DYP_ID IS NOT NULL then '1'
								WHEN d.WKP_ID IS NOT NULL then '2'
								WHEN c.COP_ID IS NOT NULL  then '3'
								WHEN e.SAP_ID IS NOT NULL then '4'
								ELSE '' END AS GUBUN -- AS 구분
						, a.TRAN_DAY AS TRAN_DAY -- AS 출금일
						, a.TR_AFTER_BAC
						, NVL(a.SEND_TM, DATE_FORMAT(a.CREAT_DT, '%H%i%s')) AS SEND_TM-- AS 출금시간
						, a.DRW_ACCOUNT_CNTN -- AS 수취인
						, f.CD_NM AS RV_BANK_NM -- AS 수취은행
						, a.RV_ACCOUNT-- AS 입금계좌번호
						, a.AMOUNT AS SEND_PRICE -- AS 거래금액
						, a.ERROR_MESSAGE
						, a.STATUS_CD
						, IF(b.DAY_FEE IS NULL, c.DAY_FEE, b.DAY_FEE ) AS DAY_FEE -- AS 선지급수수료
						, IF(b.DYP_ID IS NULL, if(c.COP_ID IS NULL, IF(e.SAP_ID IS NULL, d.FEE, e.SEND_FEE),c.SEND_FEE), b.SEND_FEE ) AS SEND_FEE -- AS 이체수수수료
						, IF(b.DYP_ID IS NULL, if(c.COP_ID IS NULL, IF(e.SAP_ID IS NULL, d.cooperator_id, ''),c.cooperator_id), b.cooperator_id ) AS COOPERATOR_ID
						, IF(b.DYP_ID IS NULL, if(c.COP_ID IS NULL, IF(e.SAP_ID IS NULL, d.mber_id, e.EMPLYR_ID),''), b.mber_id ) AS MBER_ID

						 FROM RD_TRANSFER a
						LEFT JOIN RD_DAY_PAY b ON a.TRAN_DAY = b.TRAN_DAY AND a.TELEGRAM_NO = b.TELEGRAM_NO
						LEFT JOIN RD_COOPERATOR_PAY c ON a.TRAN_DAY = c.TRAN_DAY AND a.TELEGRAM_NO = c.TELEGRAM_NO
						LEFT JOIN RD_WEEK_PAY d ON a.TRAN_DAY = d.TRAN_DAY AND a.TELEGRAM_NO = d.TELEGRAM_NO
						LEFT JOIN RD_SALES_PAY e ON a.TRAN_DAY = e.TRAN_DAY AND a.TELEGRAM_NO = e.TELEGRAM_NO
						LEFT JOIN RD_CD f ON a.RV_BANK_CODE = f.CD AND CD_GROUP ='BANK_CD'
						WHERE 1 = 1
							AND a.TRAN_DAY BETWEEN #{searchFromDate} AND #{searchToDate}
						<if test='searchGubun == "success"'>
							AND a.STATUS_CD = '0000'
						</if>
						<if test='searchGubun == "fail"'>
							AND (a.STATUS_CD != '0000' OR a.STATUS_CD is null)
						</if>
					) sub_tab
					LEFT JOIN COMTNGNRLMBER a ON sub_tab.MBER_ID = a.MBER_ID
					LEFT JOIN COMTNEMPLYRINFO b ON sub_tab.MBER_ID = b.EMPLYR_ID
					LEFT JOIN RD_COOPERATOR c ON sub_tab.COOPERATOR_ID = c.COOPERATOR_ID
					WHERE 1=1
					<if test='searchCooperatorId != null and searchCooperatorId != "all"'>
						AND sub_tab.cooperator_id = #{searchCooperatorId}
					</if>
			)tab
			where 1=1
			<if test="searchNm != null and searchNm != ''">
				AND tab.nm = #{searchNm}
			</if>
			ORDER BY tab.TRAN_DAY DESC, tab.SEND_TM DESC

	</select>
</mapper>